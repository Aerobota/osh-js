<div id="leafletViewerId">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />	
<style>

.ui-rangeSlider .ui-rangeSlider-innerBar {
    height: 20px !important;
    background: #DDD !important;
    margin: 0px 6px 3px 6px !important;
}

.sliderCustomLabel {
  border-left:1px solid #f8f8f8;
  height:20px;
}

.ui-ruler-tick-label {
  margin: 0 0 0 -2px;
  background-color: #DDD;
}
</style>

<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

<div id="leafletMap" style="height:100%;width:100%"></div>

<script>
var map;
var radixTreeStatus = new RadixTree();
var radixTreeVehId = new RadixTree();

//keep the vehicle data
var vehicleMap = new Hashtable();
//keep last data
var lastDataMap = new Hashtable();

var fireDepartmentNormalIcon = 'icons/firemen.png';
var fireDepartmentEventIcon = 'icons/firemen-event.png';

var wsFire;

function initmap() {
    // set up the map
    map = new L.Map('leafletMap');

    // create the tile layer with correct attribution
    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, {
        minZoom: 1,
        maxZoom: 19,
        attribution: osmAttrib
    });
    //,

    map.addLayer(osm);
    
    //center on huntsville
    map.setView(new L.LatLng(34.72806,-86.65698), 14);
}

var firstGps = true;

function initLayerStream(layerId,normalIcon,eventIcon,offering,startDateTime,endDateTime) {

    // GPS
    // query SOS GPS stream
    if(typeof(wsFire) != 'undefined' && wsFire != null){
      wsFire.close();
    }
    
    wsFire = new WebSocket("ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering="+offering+"&observedProperty=http://www.opengis.net/def/property/OGC/0/SensorLocation&temporalFilter=phenomenonTime,"+startDateTime+"/"+endDateTime+"&replaySpeed=20");
    wsFire.binaryType = 'arraybuffer';
    wsFire.onmessage = function(event) {
        var rec = String.fromCharCode.apply(null, new Uint8Array(event.data));
        var tokens = rec.trim().split(",");

        var date = new Date(tokens[0]);
        var mdtId = tokens[1];
        var unitId = tokens[2]; 
        var vehId = tokens[3];
        var lat = parseFloat(tokens[4]);
        var lon = parseFloat(tokens[5]);
        var status = tokens[6];
        var eventId = tokens[7];
        
        updateSlider(date,new Date(endDateTime));

        var popupContent = "<b>mtd-id : </b>"+mdtId+"</br>";
            popupContent += "<b>veh-id : </b>"+vehId+"</br>";
            popupContent += "<b>unit-id : </b>"+unitId+"</br>";
            popupContent += "<b>status : </b>"+status;
        
        var iconTypeUrl = "";
        
        if(typeof(eventId) != 'undefined'){
          if(eventId != "NONE"){
            iconTypeUrl = eventIcon;
          } else {
            iconTypeUrl = normalIcon;
          }
        }
        
        if(typeof(vehId) != 'undefined'){
          var marker;
          
          //create and insert new vehicle into hashTable
          if(!vehicleMap.get(layerId).containsKey(vehId)){
          
            //create marker
            var markerIcon = L.icon({
                iconAnchor: [16, 32],
                iconUrl: iconTypeUrl
            });

            marker = L.marker([0, 0], {
                icon: markerIcon,
                iconTypeUrl : iconTypeUrl
            }).addTo(map);
            
            marker.bindPopup(popupContent,{offset: new L.Point(0, -16)});
            vehicleMap.get(layerId).put(vehId,marker);
            
            radixTreeVehId.insert(vehId, {key : vehId,layer : layerId});
            
            lastDataMap.put(vehId,{iconTypeUrl:iconTypeUrl,popup:popupContent});
            
          } else {
            marker = vehicleMap.get(layerId).get(vehId);
          }
          
          radixTreeStatus.insert(status,{key : vehId,layer : layerId});
          
          //check if last if different and update if needed
          var last = lastDataMap.get(vehId);
          
          //update icon
         if( last.iconTypeUrl != iconTypeUrl){
            var popup = marker.getPopup();
            var isOpen = popup._isOpen;
            if(isOpen){
              marker.closePopup();
            }
            
            marker.unbindPopup();
            var markerIcon = L.icon({
                iconAnchor: [16, 32],
                iconUrl: iconTypeUrl
            });
            marker.setIcon(markerIcon);
            
            //need to recreate popup
            marker.bindPopup(popupContent,{offset: new L.Point(0, -16)});
            if(isOpen){
               marker.openPopup();
            }
            marker.update();
          } else if(last.popup != popupContent){
             marker.getPopup().setContent(popupContent);
             marker.getPopup().update();
          }
          
          if (!isNaN(lon) && !isNaN(lat)) {
            var newLatLng = new L.LatLng(lat, lon);
            marker.setLatLng(newLatLng);
            if(firstGps){
               map.setView(marker.getLatLng(), map.getZoom());
               firstGps = false;
            }
          }
          
          //update last data table
          lastDataMap.put(vehId,{iconTypeUrl:iconTypeUrl,popup:popupContent});
        }
    }

    wsFire.onerror = function(event) {
        this.close();
    }
}

initmap();



// ----------- THIS PART INTERACTS WITH THE MAIN APP  FUNCTIONS--------//
$("#fireDepartmentId,#fireDepartmentId-1").change(function(){
   var layerId = "fireDepartment";
   if(this.checked){
    //if layer has been previously loaded, we add only removed markers
    if(vehicleMap.containsKey(layerId)){
        var values = vehicleMap.get(layerId).values();
        for(var i =0;i < values.length;i++){
          values[i].addTo(map);
        }
    }else{
      //create the hashtable and init web socket connection
      vehicleMap.put(layerId,new Hashtable());
      var dateValues = $("#slider").dateRangeSlider("values");
      initLayerStream(layerId,fireDepartmentNormalIcon,fireDepartmentEventIcon,"urn:mysos:avl",dateValues.min.toISOString(),dateValues.max.toISOString());
    }
  } else {
    //remove marker from the map but they still exists and are updated since the socket is openned
    var values = vehicleMap.get(layerId).values();
    for(var i =0;i < values.length;i++){
      map.removeLayer(values[i]);
    }
  }
});

$('#filter').on("input", function() {
  if(this.value == ''){
   //remove all markers from all layers
    var values = vehicleMap.values();
    var value;
    for(var i =0;i < values.length;i++){
        //value is a layer
        var valuesLayer =  values[i].values();
        for(var j =0;j < valuesLayer.length;j++){
          map.removeLayer(valuesLayer[j]);
        }
    }
    
    //add all markers to the map
    var values = vehicleMap.values();
    var value;
    for(var i =0;i < values.length;i++){
        //value is a layer
        var valuesLayer =  values[i].values();
        for(var j =0;j < valuesLayer.length;j++){
          valuesLayer[j].addTo(map);
        }
    }
  } else {
    var filterByStatus = $("#filter-status").is(':checked');
    var filterByVehId = $("#filter-veh-id").is(':checked');
    var results = [];
    
    var hashset = new HashSet({replaceDuplicateKey:false});
    if(filterByStatus) {
      var res = radixTreeStatus.search(this.value,500000);
      for(var i = 0;i < res.length;i++){
        hashset.add(res[i]);
      }
    }
    
    if(filterByVehId) {
      var res = radixTreeVehId.search(this.value,500000);
      for(var i = 0;i < res.length;i++){
        hashset.add(res[i]);
      }
    }
    //remove all markers from all layers
    var values = vehicleMap.values();
    var value;
    for(var i =0;i < values.length;i++){
        //value is a layer
        var valuesLayer =  values[i].values();
        for(var j =0;j < valuesLayer.length;j++){
          map.removeLayer(valuesLayer[j]);
        }
    }
    
    values = hashset.values();
    
    for(var i =0;i < values.length;i++){
      value = values[i];
      vehicleMap.get(value.layer).get(value.key).addTo(map);
    }
    
    results = null;
    values = null;
  }
});



var isSliding = false;

function updateSlider(startDate,endDate){
  if(!isSliding){
      $("#slider").dateRangeSlider("values", startDate, endDate);
  }
}

$("#slider").bind("valuesChanging", function(e, data){
  isSliding = true;
  //close websocket
  if(typeof(wsFire) != 'undefined' & wsFire != null){
     wsFire.close();
     wsFire = null;
  }
});

// Preferred method
$("#slider").on("userValuesChanged", function(e, data){
    if($("#fireDepartmentId").is(":checked")){
      isSliding = false;
      //remove marker from the map but they still exists and are updated since the socket is openned
      var values = vehicleMap.get("fireDepartment").values();
      for(var i =0;i < values.length;i++){
        map.removeLayer(values[i]);
      }
      vehicleMap.get("fireDepartment").clear();
      
      //TODO : make it generic by using class for layer and store icons,layerId and offering
      initLayerStream("fireDepartment",fireDepartmentNormalIcon,fireDepartmentEventIcon,"urn:mysos:avl",data.values.min.toISOString(),data.values.max.toISOString());
      
    }
});
</script>	
</div>
