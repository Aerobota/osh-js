<div id="d3ChartViewerId">
<script>

var dataTemperature = {
	values: [],
	key : "Temp (Cel)",
	interpolate : "cardinal",
	area:true,
	color: '#ff7f0e'
};

var dataPressure = {
	values: [],
	key : "Pressure (hPa)",
	interpolate : "cardinal",
	area:true,
	
};

var dataWindSpeed = {
	values: [],
	key : "Wind Speed (m/s)",
	interpolate : "cardinal",
	color: '#2ca02c'
};

//create NVD3 graph
function getChart(data,yLabel,renderDiv) {
  var chart = nv.models.lineChart()
                .margin({left: 75,right:25})  //Adjust chart margins to give the x-axis some breathing room.
                .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!
                .transitionDuration(1)  //how fast do you want the lines to transition?
                .showLegend(false)       //Show the legend, allowing users to turn on/off line series.
                .showYAxis(true)        //Show the y-axis
                .showXAxis(true)        //Show the x-axis
               // .forceY([27.31,28])
  ;
  chart.xAxis     //Chart x-axis settings
      .axisLabel('Time')
      .tickFormat(function(d) { 
          return d3.time.format('%H:%M:%S ')(new Date(d)) 
    });
    
  chart.yAxis     //Chart y-axis settings
      .axisLabel(yLabel)
      .tickFormat(d3.format('.02f'));
  /* Done setting the chart up? Time to render it!*/

  var svg =  d3.select(renderDiv);    //Select the <svg> element you want to render the chart in.   
  svg.datum([data])         //Populate the <svg> element with chart data...
      .call(chart);          //Finally, render the chart!
     
     
  	return chart;
}

var weatherChart = getChart(dataTemperature,'Temperature (Cel)','#chartWeather svg');
var pressureChart = getChart(dataPressure,'Pressure (hPa)','#chartPressure svg');
var windSpeedChart = getChart(dataWindSpeed,'Wind Speed (m/s)','#chartWindSpeed svg');

nv.addGraph(weatherChart);
nv.addGraph(pressureChart);
nv.addGraph(windSpeedChart);

//query Weather stream
var ws = new WebSocket("ws://sensiasoft.net:8181/sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering=urn:mysos:offering03&observedProperty=http://sensorml.com/ont/swe/property/Weather&temporalFilter=phenomenonTime,now/2055-01-01Z");
ws.binaryType = 'arraybuffer';
ws.onmessage = function(event) {
 var rec = String.fromCharCode.apply(null, new Uint8Array(event.data));
 var tokens = rec.trim().split(",");
 
 var date = new Date(tokens[0]);
 var tempCel = parseFloat(tokens[1]);
 var pressure = parseFloat(tokens[2]);
 var windSpeed = parseFloat(tokens[3]);
 var windDirection = parseFloat(tokens[4]);
 
  dataTemperature.values.push({
		y : tempCel,
		x : date.getTime()
  });
    
  dataPressure.values.push({
	  y : pressure,
	  x : date.getTime()
  });
  
  dataWindSpeed.values.push({
	  y : windSpeed,
	  x : date.getTime()
  });
  
  dataWindDirection.values.push({
	  y : windDirection,
	  x : date.getTime()
  });
  
  weatherChart.update();
  pressureChart.update();
  windSpeedChart.update();
  
  if( dataTemperature.values.length > 20) {
	 dataTemperature.values.shift();
  }
  
  if( dataPressure.values.length > 20) {
	 dataPressure.values.shift();
  }
  
  if( dataWindSpeed.values.length > 20) {
	 dataWindSpeed.values.shift();
  }
}

ws.onerror = function(event) {
  ws.close();
}

// hook up the watcher
$("#widget-container").watch({
	// specify CSS styles or attribute names to monitor
	properties: "width",

	// callback function when a change is detected
	callback: function(data, i) {
		var propChanged = data.props[i];
		var newValue = data.vals[i];

		var el = this;
		var el$ = $(this);

		// do what you need based on changes
		// or do your own checks
		weatherChart.update();
	}
});
   
//Update the chart when window resizes.
nv.utils.windowResize(function() { weatherChart.update() });

</script>
<div id="chartWeather">
	 <svg style="height:34%;width:100%"> </svg>
</div>
<div id="chartPressure">
	 <svg style="height:33%;width:100%"> </svg>
</div>
<div id="chartWindSpeed">
	 <svg style="height:33%;width:100%"> </svg>
</div>
<!--div id="chartWindDirection">
	 <svg style="height:25%;width:100%"> </svg>
</div-->
</div>
