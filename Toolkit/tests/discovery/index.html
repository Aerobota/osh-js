<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title>OSH Discovery test</title>

    <!-- Nvd3 libs -->
    <link rel="stylesheet" href="../../vendor/nvd3/css/nv.d3.css" />
    <script src="../../vendor/nvd3/js/d3.v3.min.js"></script>
    <script src="../../vendor/nvd3/js/nv.d3.min.js"></script>

    <!-- ffmpeg libs -->
    <script src="../../vendor/ffmpeg/ffmpeg-h264.js"></script>
    <script src="../../vendor/ffmpeg/YUVCanvas.js"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="../../src/css/dialog.css"/>

    <!-- OSH libs -->
    <script type="text/javascript" src= "../../src/common/prototype.min.js"></script>
    <script type="text/javascript" src="../../src/common/modernizr-custom.js"></script>

    <!-- JSONIX -->
    <script type="text/javascript" src= "../../src/common/jsonix/Jsonix-min.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/Filter_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/GML_3_1_1.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/GML_3_2_1.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/IC_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/ISO19139_GCO_20070417.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/ISO19139_GMD_20070417.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/ISO19139_GSR_20070417.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/ISO19139_GSS_20070417.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/ISO19139_GTS_20070417.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/OM_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/OWS_1_1_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SensorML_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SMIL_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SMIL_2_0_Language.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SOS_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SWE_1_0_1.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SWE_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/SWES_2_0.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/WS_Addr_1_0_Core.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/WS_Addr_1_0_Core.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/WSN_T_1.js"></script>
    <script type="text/javascript" src= "../../src/common/jsonix/modules/XLink_1_0.js"></script>

    <!-- OSH Core -->
    <script type="text/javascript" src="../../src/osh/osh-template.js"></script>
    <!-- OSH buffer sync lib -->
    <script type="text/javascript" src="../../src/osh/osh-Utils.js"></script>

    <script type="text/javascript" src="../../src/osh/osh-Buffer.js"></script>
    <!-- OSH controller lib -->
    <script type="text/javascript" src="../../src/osh/osh-EventManager.js"></script>
    <!-- OSH Video component parser -->
    <script type="text/javascript" src="../../src/osh/dataconnector/osh-DataConnector.js"></script>
    <script type="text/javascript" src="../../src/osh/dataconnector/osh-DataConnector-Websocket.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-DataSource.js"></script>
    <script type="text/javascript" src="../../src/osh/osh-Sensor.js"></script>
    <script type="text/javascript" src="../../src/osh/osh-Server.js"></script>

    <!-- OSH Video component parser -->
    <script type="text/javascript"
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-DataSource.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiverController.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-LatLonAlt.js"></script>
    <script type="text/javascript"
            src="../../src/osh/datareceiver/osh-DataReceiver-OrientationQuaternion.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-VideoH264.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-VideoMjpeg.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-VideoMp4.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-Video.js"></script>
    <script type="text/javascript" src="../../src/osh/datareceiver/osh-DataReceiver-Chart.js"></script>
    <script type="text/javascript" src="../../src/osh/datasender/osh-DataSenderController.js"></script>
    <script type="text/javascript" src="../../src/osh/datasender/osh-DataSender-DataSource.js"></script>
    <script type="text/javascript" src="../../src/osh/datasender/osh-DataSender-Tasking.js"></script>

    <!--script type="text/javascript" src="../../Toolkit/src/osh/ui/osh-UI-RangeSlider.js"></script-->

    <script type="text/javascript" src="../../src/osh/ui/styler/osh-UI-Styler.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/styler/osh-UI-StylerPointMarker.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/styler/osh-UI-StylerPolyline.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/styler/osh-UI-StylerCurve.js"></script>

    <script type="text/javascript" src="../../src/osh/ui/contextmenu/osh-UI-ContextMenu.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/contextmenu/osh-UI-ContextMenu-CssMenu.js"></script>
    <script type="text/javascript"
            src="../../src/osh/ui/contextmenu/osh-UI-ContextMenu-CircularMenu.js"></script>
    <script type="text/javascript"
            src="../../src/osh/ui/contextmenu/osh-UI-ContextMenu-StackMenu.js"></script>

    <script type="text/javascript" src="../../src/osh/ui/view/osh-UI-View.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/osh-UI-DialogView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/map/osh-UI-OpenLayerView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/video/osh-UI-MjpegView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/video/osh-UI-Mp4View.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/video/osh-UI-H264View.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/video/osh-UI-FFMPEGView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/chart/osh-UI-Nvd3CurveChartView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/tasking/osh-UI-TaskingView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/entity/osh-UI-EntityTreeView.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/osh-UI-RangeSlider.js"></script>
    <script type="text/javascript" src="../../src/osh/ui/view/osh-UI-Loading.js"></script>

    <link rel="stylesheet" type="text/css" href="css/discovery.css">

    <style>

        body {
            margin: 0;
            height: 100%;
            overflow:hidden;
        }

        html {
            height: 100%;
        }

        #discovery-container {
            width : 380px;
            height: 500px;
        }

        .video-main-container {
            position:absolute;
            top:100px;
            right:15px;
            width:300px;
            height:calc(100% - 190px);
        }

        .dialog {
            width:300px;
            height:190px;
            margin-bottom:10px;
        }

        .video {
            width: 100%;
            height: 100%;
        }

        .video img{
            width: 100%;
            height: 100%;
        }

        .video canvas{
            width: 100%;
            height: 100%;
        }

        .video-selected {
            border-radius: 3px;
            box-shadow: 0px 0px 0px 8px rgba(50,205,50,0.5);
        }

    </style>
</head>
<body id="body">
<h2>Discovery test</h2>
<div id="discovery-container"></div>
<div id="dialog-main-container" class="video-main-container"></div>

<script type="text/javascript">
    OSH.UI.DiscoveryView = Class.create(OSH.UI.View, {
        initialize: function ($super, divId, properties) {
            $super(divId,[],properties);

            this.formTagId = "form-"+OSH.Utils.randomUUID();
            this.serviceSelectTagId = "service-"+OSH.Utils.randomUUID();
            this.offeringSelectTagId = "offering-"+OSH.Utils.randomUUID();
            this.observablePropertyTagId = "obsProperty-"+OSH.Utils.randomUUID();
            this.startTimeTagId = "startTime-"+OSH.Utils.randomUUID();
            this.endTimeTagId = "endTime-"+OSH.Utils.randomUUID();
            this.typeSelectTagId = "type-"+OSH.Utils.randomUUID();
            this.formButtonId = "submit-"+OSH.Utils.randomUUID();

            // add template
            var discoveryForm = document.createElement("form");
            discoveryForm.setAttribute("action","#");
            discoveryForm.setAttribute("id",this.formTagId);
            discoveryForm.setAttribute("class",'discovery-form');

            document.getElementById(this.divId).appendChild(discoveryForm);

            var strVar="";
            strVar += "<ul>";
            strVar += "            <li>";
            strVar += "                <h2>Discovery<\/h2>";
            strVar += "                <span class=\"required_notification\">* Denotes Required Field<\/span>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label>Service:<\/label>";
            strVar += "                <div class=\"select-style\">";
            strVar += "                     <select id=\""+this.serviceSelectTagId+"\" required pattern=\"^(?!Select a service$).*\">";
            strVar += "                         <option value=\"\" disabled selected>Select a service<\/option>";
            strVar += "                     <\/select>";
            strVar += "                <\/div>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label>Offering:<\/label>";
            strVar += "                <div class=\"select-style\">";
            strVar += "                    <select id=\""+this.offeringSelectTagId+"\" required>";
            strVar += "                        <option value=\"\" disabled selected>Select an offering<\/option>";
            strVar += "                    <\/select>";
            strVar += "                <\/div>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label>Observable Property:<\/label>";
            strVar += "                <div class=\"select-style\">";
            strVar += "                     <select id=\""+this.observablePropertyTagId+"\" required>";
            strVar += "                         <option value=\"\" disabled selected>Select a property<\/option>";
            strVar += "                     <\/select>";
            strVar += "                <\/div>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label for=\"startTime\">Start time:<\/label>";
            //strVar += "                <input type=\"text\" name=\"startTime\" placeholder=\"YYYY-MM-DDTHH:mm:ssZ\" required pattern=\"\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)\" />";
            strVar += "                <input id=\""+this.startTimeTagId+"\" type=\"text\" name=\"startTime\" placeholder=\"YYYY-MM-DDTHH:mm:ssZ\" required/>";
            strVar += "                <span class=\"form_hint\">YYYY-MM-DDTHH:mm:ssZ<\/span>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label for=\"endTime\">End time:<\/label>";
            //strVar += "                <input type=\"text\" name=\"endTime\" placeholder=\"YYYY-MM-DDTHH:mm:ssZ\"  required pattern=\"\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)\" />";
            strVar += "                <input id=\""+this.endTimeTagId+"\" type=\"text\" name=\"endTime\" placeholder=\"YYYY-MM-DDTHH:mm:ssZ\"  required/>";
            strVar += "                <span class=\"form_hint\">YYYY-MM-DDTHH:mm:ssZ<\/span>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <label>Type:<\/label>";
            strVar += "                <div class=\"select-style\">";
            strVar += "                    <select id=\""+this.typeSelectTagId+"\" required>";
            strVar += "                        <option value=\"\" disabled selected>Select a type<\/option>";
            strVar += "                        <option value=\"video-H264\">Video (H264)<\/option>";
            strVar += "                        <option value=\"video-MJPEG\">Video (MJPEG)<\/option>";
            strVar += "                        <option disabled value=\"marker\">Marker<\/option>";
            strVar += "                        <option value=\"chart\">Chart<\/option>";
            strVar += "                    <\/select>";
            strVar += "                <\/div>";
            strVar += "            <\/li>";
            strVar += "            <li>";
            strVar += "                <button id=\""+this.formButtonId+"\" class=\"submit\" type=\"submit\">Add<\/button>";
            strVar += "            <\/li>";
            strVar += "        <\/ul>";

            discoveryForm.innerHTML = strVar;

            // fill service from urls
            if(typeof properties != "undefined") {
                if(typeof properties.services != "undefined"){
                    this.addValuesToSelect(this.serviceSelectTagId,properties.services);
                }
            }

            // add listeners
            OSH.EventManager.observeDiv(this.serviceSelectTagId,"change",this.onSelectedService.bind(this));
            OSH.EventManager.observeDiv(this.offeringSelectTagId,"change",this.onSelectedOffering.bind(this));
            OSH.EventManager.observeDiv(this.formTagId,"submit",this.onFormSubmit.bind(this));
        },

        onSelectedService : function(event) {
            var serverTag = document.getElementById(this.serviceSelectTagId);
            var option = serverTag.options[serverTag.selectedIndex];

            // connect to server and get the list of offering
            var oshServer = new OSH.Server(option.value);

            var onSuccessGetCapabilities = function(event) {
                this.sensors = oshServer.sensors;
                // remove existing
                this.removeAllFromSelect(this.offeringSelectTagId);
                var startTimeInputTag = document.getElementById(this.startTimeTagId);
                var endTimeInputTag = document.getElementById(this.endTimeTagId);

                // add the new ones
                for(var i = 0;i < this.sensors.length;i++) {
                    this.addValueToSelect(this.offeringSelectTagId,this.sensors[i].identifier,this.sensors[i]);
                }
            }.bind(this);

            var onErrorGetCapabilities = function(event) {
            };

            oshServer.getCapabilities(onSuccessGetCapabilities,onErrorGetCapabilities);
        },

        onSelectedOffering : function(event) {
            var e = document.getElementById(this.offeringSelectTagId);
            var option = e.options[e.selectedIndex];
            this.removeAllFromSelect(this.observablePropertyTagId);

            var startTimeInputTag = document.getElementById(this.startTimeTagId);
            var endTimeInputTag = document.getElementById(this.endTimeTagId);

            // feed observable properties
            for(var i = 0; i  < option.parent.observableProperties.length;i++) {
                this.addValueToSelect(this.observablePropertyTagId,option.parent.observableProperties[i]);
                // set times
                startTimeInputTag.value = option.parent.timeRangeStart;
                endTimeInputTag.value = option.parent.timeRangeEnd;
            }
        },

        onFormSubmit : function(event) {
            event.preventDefault();
            // service
            var serviceTag = document.getElementById(this.serviceSelectTagId)
            var serviceTagSelectedOption = serviceTag.options[serviceTag.selectedIndex];

            // offering
            var offeringTag = document.getElementById(this.offeringSelectTagId)
            var offeringTagSelectedOption = offeringTag.options[offeringTag.selectedIndex];

            // obs property
            var observablePropertyTag = document.getElementById(this.observablePropertyTagId);
            var observablePropertyTagSelectedOption = observablePropertyTag.options[observablePropertyTag.selectedIndex];

            var startTimeInputTag = document.getElementById(this.startTimeTagId);
            var endTimeInputTag = document.getElementById(this.endTimeTagId);

            // get values
            var name=offeringTagSelectedOption.parent.name;
            var endPointUrl=serviceTagSelectedOption.value+"sensorhub/sos";
            var offeringID=offeringTagSelectedOption.value;
            var obsProp=observablePropertyTagSelectedOption.value;
            var startTime=startTimeInputTag.value;
            var endTime=endTimeInputTag.value;

            endPointUrl = endPointUrl.replace('http://', '');

            var typeTag = document.getElementById(this.typeSelectTagId);
            if(typeTag.value == "video-H264") {
                console.log("video");
                this.createH264VideoDialog(name,endPointUrl,offeringID,obsProp,startTime,endTime);
            } else if(typeTag.value == "video-MJPEG") {
                console.log("video");
                this.createMJPEGVideoDialog(name, endPointUrl, offeringID, obsProp, startTime, endTime);
            }
            return false;
        },

        addValuesToSelect:function(tagId,valuesArr) {
            var selectTag = document.getElementById(tagId);
            for(var i=0;i < valuesArr.length;i++) {
                var value = valuesArr[i];
                var option = document.createElement("option");
                option.text = value;
                option.value = value;
                selectTag.add(option);
            }
        },

        addValueToSelect:function(tagId,value,parent) {
            var selectTag = document.getElementById(tagId);
            var option = document.createElement("option");
            option.text = value;
            option.value = value;
            if(typeof parent != "undefined") {
                option.parent = parent;
            }
            selectTag.add(option);
        },

        removeAllFromSelect:function(tagId) {
            var i;
            var selectTag = document.getElementById(tagId);
            for (i = selectTag.options.length - 1; i > 0; i--) {
                selectTag.remove(i);
            }
        },

        createMJPEGVideoDialog:function(name,endPointUrl,offeringID,obsProp,startTime,endTime) {
            var videoDataSource = new OSH.DataReceiver.VideoMjpeg(name, {
                protocol: "ws",
                service: "SOS",
                endpointUrl: endPointUrl,
                offeringID: offeringID,
                observedProperty: obsProp,
                startTime: startTime,
                endTime: endTime,
                replaySpeed: 1,
                syncMasterTime: false,
                bufferingTime: 1000
            });

            var dialog    =  new OSH.UI.DialogView("dialog-main-container", {
                draggable: false,
                css: "dialog",
                name: name,
                show:true,
                dockable: true,
                closeable: true,
                connectionIds : [videoDataSource],
                swapId: document.body
            });

            var videoView = new OSH.UI.MjpegView(dialog.popContentDiv.id, {
                dataSourceId: videoDataSource.getId(),
                css: "video",
                cssSelected: "video-selected",
                name: "Android Video"
            });

            var dataProviderController = new OSH.DataReceiver.DataReceiverController({
                replayFactor : 1
            });

            // We can add a group of dataSources and set the options
            dataProviderController.addDataSource(videoDataSource);

            //---------------------------------------------------------------//
            //---------------------------- Starts ---------------------------//
            //---------------------------------------------------------------//

            // starts streaming
            dataProviderController.connectAll();
        },

        createH264VideoDialog:function(name,endPointUrl,offeringID,obsProp,startTime,endTime) {
            var videoDataSource = new OSH.DataReceiver.VideoH264(name, {
                protocol: "ws",
                service: "SOS",
                endpointUrl: endPointUrl,
                offeringID: offeringID,
                observedProperty: obsProp,
                startTime: startTime,
                endTime: endTime,
                replaySpeed: 1,
                syncMasterTime: false,
                bufferingTime: 1000
            });

            var dialog    =  new OSH.UI.DialogView("dialog-main-container", {
                draggable: false,
                css: "dialog",
                name: name,
                show:true,
                dockable: true,
                closeable: true,
                connectionIds : [videoDataSource],
                swapId: document.body
            });

            var videoView = new OSH.UI.FFMPEGView(dialog.popContentDiv.id, {
                dataSourceId: videoDataSource.getId(),
                css: "video",
                cssSelected: "video-selected",
                name: "Android Video"
            });

            var dataProviderController = new OSH.DataReceiver.DataReceiverController({
                replayFactor : 1
            });

            // We can add a group of dataSources and set the options
            dataProviderController.addDataSource(videoDataSource);

            //---------------------------------------------------------------//
            //---------------------------- Starts ---------------------------//
            //---------------------------------------------------------------//

            // starts streaming
            dataProviderController.connectAll();
        },

        createChartDialog:function() {

        }
    });

    new OSH.UI.DiscoveryView("discovery-container",{
        services: ["http://sensiasoft.net:8181/"]
    });
</script>

</body>
</html>
